# Copilot Instructions for XDrive_APP

- **Project/target**: Keil uVision (MDK 5.27) firmware for STM32F103CB using ArmClang 6.11; target configured in [XDrive_APP.uvprojx](XDrive_APP.uvprojx). Outputs: AXF/HEX in [XDrive_APP](XDrive_APP), BIN via post-build `fromelf --bin` to [BIN/xdrive_app.bin](BIN/xdrive_app.bin); check [XDrive_APP/XDrive_APP.build_log.htm](XDrive_APP/XDrive_APP.build_log.htm) for exact switches.
- **Memory/map**: Scatter file `..\\Config\\X _Drive.sct` referenced by the target; flash 0x08000000 size 0x20000, RAM 0x20000000 size 0x5000. Inspect [XDrive_APP/XDrive_APP.map](XDrive_APP/XDrive_APP.map) when adding code.
- **Compile options**: Global defines `USE_HAL_DRIVER`, `STM32F103xB`; include paths cover `../Core/Inc`, HAL/CMSIS, and project layers `..\\Base_Drivers`, `..\\Base_Math`, `..\\Config`, `..\\Control`, `..\\Data_Link`, `..\\Debug`, `..\\Kernel`, `..\\Demo`. Add new headers in these roots or extend the include path and register them in [XDrive_APP.uvprojx](XDrive_APP.uvprojx).
- **Runtime architecture**: [Core/Src/main.c](../Core/Src/main.c) only boots HAL and jumps into [Kernel/loop.c](../Kernel/loop.c); the infinite `for(;;)` in `loop()` runs timing helpers then `Calibration_Loop_Callback()` (calibration/solve stage). UI init and button/OLED setup also happen in `loop()` before entering the main cycle.
- **Timing/interrupt model**: [Kernel/loop_it.c](../Kernel/loop_it.c) reprograms SysTick to 20 kHz (`LoopIT_SysTick_20KHz()`), samples the MT6816 encoder and power in `SysTick_Handler`, then dispatches either calibration (`Calibration_Interrupt_Callback`) or control (`Motor_Control_Callback`) per `encode_cali.trigger`. A 1 ms divider inside SysTick calls `loop_second_base_1ms()` and `HAL_IncTick()` to keep HAL delays working.
- **Subclock tasks**: `loop_second_base_1ms()` increments 10/20/50/100 ms counters; `time_second_run()` executes those callbacks. UI refresh runs at 50 Hz inside `time_second_20ms_serve()`.
- **Interrupt priorities**: `LoopIT_Priority_Overlay()` sets NVIC priorities differently for `XDrive_Run` variants (`XDrive_REIN_Basic_H1_1` vs `_H1_0`), prioritizing signal capture over control and comms. Check the IRQ list in [Kernel/loop_it.c](../Kernel/loop_it.c) before adding ISRs or changing priorities.
- **Control stack**: [Control/motor_control.c](../Control/motor_control.c) hosts PID speed and DCE position controllers, produces `foc_location/current`, and drives the hardware via `REIN_HW_Elec_SetDivideElec`. Movement estimation and interpolation live in `Location_Tracker`, `Speed_Tracker`, `Current_Tracker`, `Move_Reconstruct`, `Location_Interp` (see corresponding files under `../Control`). Parameters and defaults reside in `control_config.*`; board/runtime config lives in [Config/stockpile_f103cb.c](../Config/stockpile_f103cb.c).
- **Drivers/interfaces**: Sensor readout is via [Base_Drivers/mt6816.c](../Base_Drivers/mt6816.c); power stage control via [Base_Drivers/hw_elec.c](../Base_Drivers/hw_elec.c); IO capture (PWM/count/dir) via [Base_Drivers/signal_port.c](../Base_Drivers/signal_port.c). Keep HAL glue under `../Core/Src` in CubeMX user regions when possible.
- **Calibration/UI**: Encoder calibration flows are in `encode_cali.*`; `encode_cali.trigger` gates whether SysTick runs calibration vs control. UI helpers live in `../Debug/xdrive_ui.c`, with OLED/button setup in `loop()` and periodic refresh in the 20 ms tick.
- **Build/debug tips**: Use uVision target `XDrive_APP`; ensure CMSIS 5.4.0 and STM32F1 DFP 2.0.0 packs plus ArmClang path `E:\Keil5\ARM\ARMCLANG\Bin`. Post-build converts AXFâ†’BIN automatically; keep scatter file and pack versions aligned when flashing (J-Link DLL `Segger\\JL2CM3.dll`).
- **Adding code safely**: Prefer extending Control/Base_* layers instead of editing HAL sources. When introducing new modules, place them in the appropriate layer folder, add to the project file, and wire into the 20 kHz control path or slower subclock hooks rather than the 1 ms HAL tick. Preserve GPL headers where present.
